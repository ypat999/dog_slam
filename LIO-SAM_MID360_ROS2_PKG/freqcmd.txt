# 编译（狗里面，排除gazebo模拟环境，如果要模拟则去掉--packages-skip livox_gazebo_ros2_gpu_simulation）
cd ~/dog_slam/LIO-SAM_MID360_ROS2_PKG/ros2/
source install/setup.bash
colcon build --symlink-install --parallel-workers 8 --packages-skip livox_gazebo_ros2_gpu_simulation



# 机器狗站立：
ros2 service call /rkbot/setctrlmode robot_interface/srv/SetCtrlMode "{mode: {value: 1}}"

# 机器狗半蹲：
ros2 service call /rkbot/setctrlmode robot_interface/srv/SetCtrlMode "{mode: {value: 2}}"

# 机器狗趴下：
ros2 service call /rkbot/setctrlmode robot_interface/srv/SetCtrlMode "{mode: {value: 0}}"

# 关闭控制服务
sudo systemctl stop robot_control.service




# 启动可视化（在导航前启动，占cpu多可考虑设置初始点后关闭）：
rviz2

# 启动建图：
sudo systemctl start lio_sam_buildmap.service

# 查看日志（启动后尽快运行，避免错过ERROR）：
sudo journalctl -u lio_sam_buildmap.service -f

#全自动建图及日志
sudo systemctl start auto_buildmap.service
sudo journalctl -u auto_buildmap.service -f

# 或  使用slamtoolbox建图
MANUAL_BUILD_MAP=true BUILD_TOOL=slam_toolbox SLAM_ALGORITHM=lio_sam ros2 launch nav2_dog_slam lio_nav2_unified.launch.py localization:=slam_toolbox
MANUAL_BUILD_MAP=true BUILD_TOOL=slam_toolbox SLAM_ALGORITHM=fast_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py localization:=slam_toolbox
MANUAL_BUILD_MAP=true BUILD_TOOL=slam_toolbox SLAM_ALGORITHM=super_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py localization:=slam_toolbox

# 保存二维地图(amcl)：
source ros2/install/setup.bash 
ros2 run nav2_map_server map_saver_cli -t /projected_map -f /home/ztl/slam_data/map_10 --fmt png

# 保存位姿图(slam_toolbox)：
# 调用 serialize_map 服务保存序列化地图
ros2 service call /slam_toolbox/serialize_map slam_toolbox/srv/SerializePoseGraph "{filename: '/home/ztl/slam_data/posegraph/my_map'}"
ros2 service call /slam_toolbox/save_map slam_toolbox/srv/SaveMap "{name: {data: '/home/ztl/slam_data/posegraph/my_2dmap'}}"



# 保存lio-sam点云 （不使用）
source ros2/install/setup.bash 
ros2 service call /lio_sam/save_map lio_sam/srv/SaveMap "{}"

# 从pcd点云截取2d栅格地图
scripts/pcd_to_png_and_yaml.py

# 录制点云信息供离线调试：
cd dog_slam
source LIO-SAM_MID360_ROS2_PKG/ros2/install/setup.bash
nohup ros2 bag record -o /home/ztl/slam_data/livox_record_tilt_test/ /livox/lidar /livox/imu > record.log &
tail -f record.log 
ps -ef | grep  livox_record_tilt_test
kill -

# 关闭建图：
sudo systemctl stop lio_sam_buildmap.service













# 启动导航：
sudo systemctl start lio_sam_nav2.service

# 查看日志（启动后尽快运行，避免错过ERROR）：
sudo journalctl -u lio_sam_nav2.service -f

# 设置初始点：
rviz2内点击2d pose estimate后点击地图拖动方向

# 设置目标点：
rviz2内点击2d goal后点击地图拖动方向

# 地图刷新：
ros2 service call /map_server/load_map nav2_msgs/srv/LoadMap "{map_url: '/home/ztl/slam_data/grid_map/map.yaml'}"

# 定位模块全局自动重定位：
ros2 service call /reinitialize_global_localization std_srvs/srv/Empty {}

#保存fastlio点云
ros2 service call /map_save std_srvs/srv/Trigger {}

# 关闭导航：
sudo systemctl stop lio_sam_nav2.service

# 检查组件是否完全关闭：
ps -ef | grep rosbridge
ps -ef | grep rclcpp
lsof -i:8083
















# 启动模拟
ros2 launch livox_gazebo_ros2_gpu_simulation my_robot.launch.py

# 手动控制
ros2 run livox_gazebo_ros2_gpu_simulation omni_teleop.py

# slam_toolbox + nav2 + pointlio建图导航
MANUAL_BUILD_MAP=true BUILD_TOOL=slam_toolbox SLAM_ALGORITHM=point_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py localization:=slam_toolbox
MANUAL_BUILD_MAP=true BUILD_TOOL=slam_toolbox SLAM_ALGORITHM=super_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py localization:=slam_toolbox

# slam_toolbox + nav2 + liosam建图导航
MANUAL_BUILD_MAP=false BUILD_TOOL=slam_toolbox SLAM_ALGORITHM=lio_sam ros2 launch nav2_dog_slam lio_nav2_unified.launch.py localization:=slam_toolbox
MANUAL_BUILD_MAP=false BUILD_TOOL=slam_toolbox SLAM_ALGORITHM=super_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py localization:=slam_toolbox

# 自动探索建图
ros2 launch explore_lite explore.launch.py



# 三维定位
ros2 launch lidar_localization_ros2 lidar_localization.launch.py

#全局定位
ros2 run nav2_dog_slam surf_map_matching.py

# SC-posegraph
ros2 launch sc_pgo_ros2 sc_pgo.launch.py













# 其他：

echo $DISPLAY

export ROS_DOMAIN_ID=27
cd ros2
export DISPLAY=localhost:10.0

colcon build --symlink-install --packages-select lio_sam && source install/setup.bash &&MANUAL_BUILD_MAP=True ros2 launch lio_sam lio_sam.launch.py
colcon build --symlink-install --packages-select lio_sam && source install/setup.bash && ros2 launch nav2_dog_slam nav2.launch.py

/home/ywj/projects/git/dog_slam/LIO-SAM_MID360_ROS2_PKG/ros2/src/LIO-SAM_MID360_ROS2_DOG/web/run_web.sh




ros2 topic list
ros2 node list

pkill -f ros
ros2 daemon stop && ros2 daemon start


ros2 run tf2_ros tf2_monitor map odom

ros2 lifecycle set /static_transform_publisher_odom_base shutdown


source install/setup.bash
nohup SLAM_ALGORITHM=lio_sam ros2 launch nav2_dog_slam lio_nav2_unified.launch.py ns:=/ > record.log &
nohup SLAM_ALGORITHM=super_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py ns:=/ > record.log &
tail -f record.log



ps -ef | grep ros



MANUAL_BUILD_MAP=True ros2 launch lio_sam lio_sam.launch.py
MANUAL_BUILD_MAP=False SLAM_ALGORITHM=lio_sam ros2 launch nav2_dog_slam lio_nav2_unified.launch.py

MANUAL_BUILD_MAP=False SLAM_ALGORITHM=point_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py

MANUAL_BUILD_MAP=False SLAM_ALGORITHM=super_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py

ros2 launch fast_lio mapping.launch.py
ros2 launch lio_sam lio_sam.launch.py
ros2 launch point_lio mapping_mid360.launch.py
ros2 launch super_lio Livox_mid360.py

SLAM_ALGORITHM=fast_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py
ros2 launch livox_ros_driver2 msg_MID360_launch.py


SLAM_ALGORITHM=fast_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py
SLAM_ALGORITHM=lio_sam ros2 launch nav2_dog_slam lio_nav2_unified.launch.py
SLAM_ALGORITHM=point_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py
SLAM_ALGORITHM=super_lio ros2 launch nav2_dog_slam lio_nav2_unified.launch.py







export MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA   #使用独显
glxinfo | grep "OpenGL renderer"
export GAZEBO_GPU_RENDERING=1






# 查看当前生命周期节点状态
ros2 lifecycle list fastlio_mapping

# 查看节点当前状态
ros2 lifecycle get fastlio_mapping

# 重启节点（完整的生命周期转换）
ros2 lifecycle set fastlio_mapping deactivate
ros2 lifecycle set fastlio_mapping cleanup
ros2 lifecycle set fastlio_mapping configure
ros2 lifecycle set fastlio_mapping activate


# 查看节点服务列表
ros2 service list | grep fastlio_mapping

# 通过生命周期管理器服务重启
ros2 service call /lifecycle_manager_fastlio/manage_nodes lifecycle_msgs/srv/ManageNodes "{command: 1}"

# 停止当前节点
ros2 lifecycle set /fastlio_mapping shutdown

# 重新启动launch文件
ros2 launch fast_lio mapping.launch.py



nohup ros2 launch fast_lio mapping.launch.py > recordlio.log & && nohup ros2 launch sc_pgo_ros2 sc_pgo.launch.py > recordsc.log &
