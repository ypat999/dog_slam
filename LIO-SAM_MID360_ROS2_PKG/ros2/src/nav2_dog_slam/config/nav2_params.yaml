# =============================================================================
# NAV2 Configuration - Merged Beam & Likelihood Model
# =============================================================================
# 使用说明：
# 1. 取消注释需要的模型参数块，注释掉另一个模型
# 2. Beam模型适用于结构化环境，Likelihood模型适用于非结构化环境
# 3. 两个模型共享MPPI控制器和其他模块配置
# =============================================================================

# =============================================================================
# Lifecycle Manager Configuration
# =============================================================================
lifecycle_manager:
  ros__parameters:
    use_sim_time: false
    autostart: true
    node_names: ['planner_server', 'controller_server', 'bt_navigator', 'waypoint_follower', 'velocity_smoother']
    bond_timeout_ms: 10000

# 单独的定位生命周期管理器配置
lifecycle_manager_localization:
  ros__parameters:
    use_sim_time: false
    autostart: true
    node_names: ['map_server', 'amcl']
    bond_timeout_ms: 10000

# =============================================================================
# AMCL Configuration - 模型选择区域
# =============================================================================
amcl:
  ros__parameters:
    use_sim_time: false
    
    # 基础参数 - 两个模型共用
    min_particles: 500
    max_particles: 4000
    pf_err: 0.03      # 修正参数名：kld_err -> pf_err
    pf_z: 0.97        # 修正参数名：kld_z -> pf_z
    
    # # 缺失参数 - 根据系统输出添加
    # bond_disable_heartbeat_timeout: false  # 新增参数
    # tf_broadcast: true                     # 新增参数
    # transform_tolerance: 0.1               # 新增参数
    # map_topic: "map"                       # 新增参数
    
    # 里程计运动模型噪声参数 - 室内环境优化
    alpha1: 0.2            # 进一步降低旋转-旋转噪声，室内旋转需要更高精度
    alpha2: 0.07           # 进一步降低平移-旋转噪声，室内直线运动更稳定
    alpha3: 0.2            # 降低平移-平移噪声，室内环境减少位置漂移
    alpha4: 0.07           # 进一步降低旋转-平移噪声，提高室内整体定位稳定性
    alpha5: 0.005           # 降低额外噪声参数，室内环境更可预测
    
    # 机器人运动模型类型 - 全向移动
    # robot_model_type: "nav2_amcl::OmniMotionModel"
    robot_model_type: "nav2_amcl::DifferentialMotionModel"
    
    # 更新阈值 - 两个模型共用
    update_min_d: 0.3
    update_min_a: 0.2
    resample_interval: 1
    # selective_resampling: false  # 删除不存在的参数
    
    # 恢复参数 - 两个模型共用
    recovery_alpha_slow: 0.001
    recovery_alpha_fast: 0.1
    
    # 坐标系配置 - 两个模型共用
    global_frame_id: map
    odom_frame_id: odom
    base_frame_id: base_link
    scan_topic: /scan
    
    # 初始位姿配置 - 两个模型共用
    set_initial_pose: true
    always_reset_initial_pose: true
    first_map_only: false
    # map_padding: 0.3      # 删除不存在的参数
    save_pose_rate: 0.3
    initial_pose:
      x: 29.925  
      y: 15.184 
      z: 0.5
      yaw: -1.396 

    # 激光雷达配置
    laser_min_range: 0.3
    laser_max_range: 40.0
    # laser_beam_step: 4
    max_beams: 180
    
    # odom_topic: /lio_sam/mapping/odometry

    # =============================================================================
    # BEAM MODEL 参数 - 适用于结构化环境
    # 取消注释使用Beam模型，注释掉Likelihood模型参数
    # =============================================================================
    # # Beam模型标识
    # laser_model_type: "beam"
    
    # # Beam模型特有参数
    # lambda_short: 0.1
    # sigma_hit: 0.08
    # z_hit: 0.70
    # z_rand: 0.20
    # z_max: 0.15  # Beam模型特有参数
    # z_short: 0.05  # Beam模型特有参数
    

    
    # =============================================================================
    # LIKELIHOOD FIELD MODEL 参数 - 适用于非结构化环境
    # 取消注释使用Likelihood模型，注释掉Beam模型参数
    # =============================================================================
    # Likelihood模型标识
    laser_model_type: "likelihood_field_prob"
    
    # Likelihood模型特有参数
    lambda_short: 0.1
    sigma_hit: 0.08
    z_hit: 0.70
    z_rand: 0.30
    # z_max: 0.15    # 注释掉 - Likelihood模型不需要此参数
    # z_short: 0.05  # 注释掉 - Likelihood模型不需要此参数
    
    # 缺失参数 - 根据系统输出添加
    # beam_skip_error_threshold: 0.1  # 新增参数
    
    # Likelihood距离参数
    laser_likelihood_max_dist: 40.0
    
    # Beam跳过参数（Likelihood模型也使用）
    do_beamskip: true    #AMCL 会在计算权重时自动跳过异常束
    beam_skip_distance: 0.8  #如果某个激光束测得的距离与地图上预测的距离相差超过 0.5 米，AMCL 认为这根束"异常"，不参与粒子权重计算。
    beam_skip_threshold: 0.4   #如果异常束比例 超过 0.4（即 40%），则认为当前帧激光数据整体质量太差，不进行正常权重更新，以免错误影响定位。
    
    # # QoS覆盖参数 - 新增
    # qos_overrides:
    #   /tf.publisher:
    #     depth: 100
    #     durability: "volatile"
    #     history: "keep_last"
    #     reliability: "reliable"

# =============================================================================
# BT Navigator Configuration
# =============================================================================
bt_navigator:
  ros__parameters:
    use_sim_time: false
    global_frame: map
    robot_base_frame: base_link
    bt_loop_duration: 10
    default_server_timeout: 20
    wait_for_service_timeout: 10
    
    # 缺失参数 - 根据系统输出添加
    # bond_disable_heartbeat_timeout: false
    # always_reload_bt_xml: false
    # default_nav_through_poses_bt_xml: "/opt/ros/humble/share/nav2_bt_navigator/behavior_trees/navigate_to_pose_w_replanning_and_recovery.xml"
    # odom_topic: "odom"
    # goal_blackboard_id: "goal"
    # goals_blackboard_id: "goals"
    # path_blackboard_id: "path"
    # transform_tolerance: 0.1
    
    # 行为树配置 - 使用ROS2标准行为树文件
    default_nav_to_pose_bt_xml: "/home/ztl/dog_slam/LIO-SAM_MID360_ROS2_PKG/ros2/src/nav2_dog_slam/config/navigate_to_pose_w_replanning_and_recovery.xml"
    
    # 未使用的行为树文件（系统存在但当前配置未使用）:
    # - /opt/ros/humble/share/nav2_bt_navigator/behavior_trees/navigate_w_replanning_and_round_robin_recovery.xml (系统无此文件)
    # - /opt/ros/humble/share/nav2_bt_navigator/behavior_trees/odometry_calibration.xml (特殊用途，不用于导航)
    
    # Groot监控
    enable_groot_monitoring: false
    groot_zmq_publisher_port: 1666
    groot_zmq_server_port: 1667
    
    # # QoS覆盖配置
    # qos_overrides:
    #   /tf:
    #     subscription:
    #       depth: 100
    #       durability: "volatile"
    #       history: "keep_last"
    #       reliability: "reliable"
    #   /tf_static:
    #     subscription:
    #       depth: 100
    #       durability: "transient_local"
    #       history: "keep_last"
    #       reliability: "reliable"
    
    # 插件库
    plugin_lib_names: 
      - nav2_compute_path_to_pose_action_bt_node
      - nav2_compute_path_through_poses_action_bt_node
      - nav2_smooth_path_action_bt_node
      - nav2_follow_path_action_bt_node
      - nav2_spin_action_bt_node
      - nav2_wait_action_bt_node
      - nav2_assisted_teleop_action_bt_node
      - nav2_back_up_action_bt_node
      - nav2_drive_on_heading_bt_node
      - nav2_clear_costmap_service_bt_node
      - nav2_is_stuck_condition_bt_node
      - nav2_goal_reached_condition_bt_node
      - nav2_goal_updated_condition_bt_node
      - nav2_globally_updated_goal_condition_bt_node
      - nav2_is_path_valid_condition_bt_node
      - nav2_initial_pose_received_condition_bt_node
      - nav2_reinitialize_global_localization_service_bt_node
      - nav2_rate_controller_bt_node
      - nav2_distance_controller_bt_node
      - nav2_speed_controller_bt_node
      - nav2_truncate_path_action_bt_node
      - nav2_truncate_path_local_action_bt_node
      - nav2_goal_updater_node_bt_node
      - nav2_recovery_node_bt_node
      - nav2_pipeline_sequence_bt_node
      - nav2_round_robin_node_bt_node
      - nav2_transform_available_condition_bt_node
      - nav2_time_expired_condition_bt_node
      - nav2_path_expiring_timer_condition
      - nav2_distance_traveled_condition_bt_node
      - nav2_single_trigger_bt_node
      - nav2_goal_updated_controller_bt_node
      - nav2_is_battery_low_condition_bt_node
      - nav2_navigate_through_poses_action_bt_node
      - nav2_navigate_to_pose_action_bt_node
      - nav2_remove_passed_goals_action_bt_node
      - nav2_planner_selector_bt_node
      - nav2_controller_selector_bt_node
      - nav2_goal_checker_selector_bt_node
      - nav2_controller_cancel_bt_node
      - nav2_path_longer_on_approach_bt_node
      - nav2_wait_cancel_bt_node
      - nav2_spin_cancel_bt_node
      - nav2_back_up_cancel_bt_node
      - nav2_assisted_teleop_cancel_bt_node
      - nav2_drive_on_heading_cancel_bt_node
      - nav2_is_battery_charging_condition_bt_node
      - nav2_progress_checker_selector_bt_node


# =============================================================================
# Controller Server Configuration - MPPI控制器
# =============================================================================
controller_server:
  ros__parameters:
    controller_server: 
      verbose: true
    
    # 缺失的顶层参数
    # bond_disable_heartbeat_timeout: false  # 新增参数
    use_sim_time: false
    controller_frequency: 40.0  # 保持10Hz控制器频率
    failure_tolerance: 5.0

    min_x_velocity_threshold: 0.05
    min_y_velocity_threshold: 0.1
    min_theta_velocity_threshold: 0.1  # 提高最小角速度阈值，避免低速无法转动

    # odom_topic: "/Odometry"  # 新增参数
    # publish_zero_velocity: true  # 新增参数
    # speed_limit_topic: "/speed_limit"  # 新增参数
    
    # 插件配置
    controller_plugins: ["FollowPath"]  # 新增参数
    # controller_plugin: "FollowPath"
    
    # 其他缺失参数
    goal_checker_plugins: ["goal_checker"]  # 新增参数
    goal_checker_plugin: "goal_checker"
    
    progress_checker_plugin: "progress_checker"  # 新增参数
  
    
    # 进度检查器参数 - 配合新行为树优化
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.10  # 增加移动半径，从0.1增加到0.15，减少误判
      movement_time_allowance: 30.0  # 减少移动时间容差，从30.0减到20.0，提高响应速度
    
    # 目标检查器参数 - 优化终点减速和停止精度
    goal_checker:
      plugin: "nav2_controller::StoppedGoalChecker"
      xy_goal_tolerance: 0.5  # 进一步减小位置容差，提高停止精度
      yaw_goal_tolerance: 0.3  # 进一步减小角度容差，避免过度修正
      trans_stopped_velocity: 1.5
      rot_stopped_velocity: 1.5
      stateful: true

    # MPPI控制器参数 - 全向移动配置（实时性优化）
    FollowPath:
      plugin: "nav2_mppi_controller::MPPIController"
      # time_steps: 40  # 大幅减少时间步数，从40减到20，降低计算延迟
      time_steps: 30
      model_dt: 0.025
      batch_size: 500  # 大幅减少批量大小，从1500减到800，提高计算速度
      transform_tolerance: 0.5  # 减少变换容差，提高实时性
      
      # 全向移动速度限制 - 适应机器人结构特性
      ax_max: 1.0
      ax_min: -5.0
      az_max: 5.0
      az_min: -5.0
      vx_std: 0.25  # 降低线速度采样标准差，减少速度波动
      wz_std: 0.35  # 提高角速度采样标准差，增加转向探索性
      
      # vx_max: 1.2
      vx_max: 0.6
      vy_max: 0.0
      vy_std: 0.2  # 降低横移速度采样标准差
      vx_min: -0.06
      wz_max: 1.2
      # wz_max: 0.8
      
      
      # 温度参数
      temperature: 0.1
      motion_model: "DiffDrive" 
      # motion_model: "Omni"  # 全向移动模型
      reset_period: 0.5

      visualize: false
      publish_optimal_trajectory: false
      # TrajectoryVisualizer参数
      TrajectoryVisualizer:
        time_step: 10  # 新增参数
        trajectory_step: 10  # 新增参数
      
      # # 缺失的MPPI参数
      enforce_path_inversion: false  # 强制变向
      # inversion_xy_tolerance: 0.3
      # inversion_yaw_tolerance: 0.2
      # gamma: 0.015  # 新增参数
      # iteration_count: 1  # 新增参数
      max_robot_pose_search_dist: 1.0  # Max integrated distance ahead of robot pose to search for nearest path point in case of path looping.
      # prune_distance: 1.0  # 新增参数
      # regenerate_noises: true  # 新增参数
      # retry_attempt_limit: 1  # 新增参数
      
      # 评价器参数 - 优化权重以提高停止精度
      critics: ["ConstraintCritic", "CostCritic",  "PathFollowCritic", "GoalCritic", "PreferForwardCritic", "GoalAngleCritic", "VelocityDeadbandCritic"] # "PathAngleCritic", "TwirlingCritic",  

      ConstraintCritic:
        enabled: true
        cost_power: 1
        cost_weight: 10.0  # 保持安全性权重
      
      CostCritic:
        enabled: true
        cost_weight: 50.0  # 大幅增加避障成本权重，强制避障
        cost_power: 2      # 大幅增加成本幂次，使靠近障碍物时成本急剧增加
        collision_cost: 254.0  # 碰撞成本设为最大值
        consider_footprint: true  # 考虑机器人轮廓
        critical_cost: 254.0  # 临界成本设为最大值
        inflation_layer_name: "inflation_layer_local"
        near_goal_distance: 1.0  # 近目标距离
        
      PathFollowCritic:
        enabled: true
        cost_weight: 20.0  # 进一步降低路径跟踪权重，减少左右震荡
        cost_power: 1
        offset_from_furthest: 4  # 减少前瞻距离，提高实时响应
        threshold_to_consider: 1.0  # Distance (m) between robot and goal to stop considering path following and allow goal critics to take over. It is wise to start with this as being the same as your prediction horizon to have a clean hand-off with the goal critic.
      
      # PathAngleCritic:
      #   enabled: false
      #   cost_weight: 9.0  # 大幅降低权重，减少方向修正的过度反应
      #   cost_power: 1
      #   # forward_preference: true
      #   offset_from_furthest: 4  # 进一步减少前瞻距离，提高实时响应
      #   threshold_to_consider: 1.0  # Distance (m) between robot and goal to stop considering path angles and allow goal critics to take over.
      #   max_angle_to_furthest: 0.02  # 大幅减少最大角度阈值，避免过度修正
        
      PreferForwardCritic:
        enabled: true
        cost_power: 1
        cost_weight: 10.0  # 降低权重，减少直线前进的强制性
        threshold_to_consider: 1.0  #Distance (m) between robot and goal to stop considering preferring forward and allow goal critics to take over.
      
      # TwirlingCritic:
      #   enabled: false
      #   cost_weight: 20.0     # 强惩绕圈行为

      VelocityDeadbandCritic: 
        enabled: true
        cost_weight: 30.0  # 增加死区评价器权重，减少低速抖动
        cost_power: 1
        deadband_velocities: [0.05, 0.1, 0.1]
        
      GoalCritic:
        enabled: true
        cost_weight: 25.0  # 增加目标对齐评价器权重，强化终点减速
        cost_power: 1  # 增加成本幂次，使距离目标越近减速效果越明显
        threshold_to_consider: 1.0  # Minimal distance (m) between robot and goal above which goal distance cost considered. It is wise to start with this as being the same as your prediction horizon to have a clean hand-off with the path follower critic.

      GoalAngleCritic:
        enabled: true
        cost_weight: 25.0  
        cost_power: 1 
        threshold_to_consider: 0.5 #Minimal distance (m) between robot and goal above which angle goal cost considered.


# =============================================================================
# Velocity Smoother Configuration
# =============================================================================
velocity_smoother:
  ros__parameters:
    # 缺失的顶层参数
    # bond_disable_heartbeat_timeout: false  # 新增参数
    
    use_sim_time: false
    smoothing_frequency: 40.0
    scale_velocities: true
    feedback: "OPEN_LOOP" 

    # feedback: "CLOSED_LOOP"  
    # odom_topic: "/Odometry"
    # odom_duration: 0.1
    
    # 移动速度限制 - 降低速度避免过于激进
    max_velocity: [2.5, 1.5, 5.0]  # [vx_max, vy_max, vtheta_max] - 降低最大速度
    min_velocity: [-0.1, -1.5, -5.0]  # [vx_min, vy_min, vtheta_min] - 降低最小速度
    
    # 加速度限制 - 降低加速度避免急转急停
    max_accel: [2.0, 3.0, 5.0]  # [ax_max, ay_max, atheta_max] - 降低加速度
    max_decel: [-10.0, -3.0, -5.0]  # [ax_min, ay_min, atheta_min] - 降低减速度
    
    # 其他参数
    deadband_velocity: [0.05, 0.1, 0.1]  # 设置死区速度，避免输出-0.01到+0.01之间的速度  被忽略
    velocity_timeout: 1.0


# =============================================================================
# Planner Server Configuration
# =============================================================================
planner_server:
  ros__parameters:
    use_sim_time: false
    expected_planner_frequency: 0.1
    planner_plugins: ["GridBased"]

    GridBased:
      plugin: "nav2_smac_planner/SmacPlannerHybrid"

      # # ---- 启用方向模型（必需，否则没倒车）----
      # motion_model_for_search: "REEDS_SHEPP"

      # # ---- 倒车代价（越高越不愿倒车）----
      # # 建议：1.5～3.0：允许倒车但倾向前进
      # reverse_penalty: 5.0

      # # ---- 切换前进/倒车的代价 ----
      # change_penalty: 9.9

      # # ---- 转弯代价（可稍微提高让路径更自然）----
      # non_straight_penalty: 1.2

      # retrospective_penalty: 10.0

      tolerance: 0.5
      planner_timeout: 10.0
      allow_unknown: true
      max_iterations: 1000000
      max_on_approach_iterations: 10000
      minimum_turning_radius: 0.2
      angle_quantization_bins: 72
      cache_obstacle_heuristic: true
      cache_analytic_expansion: false
      smooth_path: true


# =============================================================================
# Local Costmap Configuration
# =============================================================================
local_costmap:
  local_costmap:
    ros__parameters:
      # 缺失的顶层参数
      # bond_disable_heartbeat_timeout: false  # 新增参数
      use_sim_time: false
      update_frequency: 10.0
      publish_frequency: 10.0
      global_frame: odom
      robot_base_frame: base_link
      transform_tolerance: 0.5
      
      # 地图参数
      footprint: "[[-0.4, -0.2], [-0.4, 0.2], [0.2, 0.2], [0.2, -0.2]]"  # 机器狗矩形footprint（base_link前移10cm）
      footprint_padding: 0.05  # footprint膨胀填充
      resolution: 0.05
      rolling_window: true
      width: 8
      height: 8
      
      # # 其他缺失参数
      # footprint: ""  # 新增参数 - 使用robot_radius代替
      # footprint_padding: 0.01  # 新增参数
      # lethal_cost_threshold: 100  # 新增参数
      # map_topic: "/map"  # 新增参数
      # observation_sources: "scan"  # 新增参数
      # origin_x: 0.0  # 新增参数
      # origin_y: 0.0  # 新增参数
      # track_unknown_space: false  # 新增参数
      # trinary_costmap: true  # 新增参数
      # unknown_cost_value: 255  # 新增参数
      # use_maximum: false  # 新增参数
      
      # # 过滤器配置
      # filters: []  # 新增参数 - 无过滤器
      
      # 插件配置
      plugins: [ "obstacle_layer_local", "inflation_layer_local"] #"voxel_layer",
      
      # # 体素层参数
      # voxel_layer:
      #   plugin: "nav2_costmap_2d::VoxelLayer"
      #   enabled: true
      #   publish_voxel_map: true
      #   origin_z: 0.0  # 负值以容纳传感器原点的负值z坐标
      #   z_resolution: 0.05
      #   z_voxels: 16    # 增加体素数量以保持足够的垂直覆盖范围
      #   max_obstacle_height: 2.0
      #   min_obstacle_height: -0.5
      #   # mark_threshold: 0.5
      #   observation_sources: scan
      #   scan:
      #     topic: /scan
      #     max_obstacle_height: 1.8
      #     min_obstacle_height: -0.5
      #     clearing: true
      #     marking: false
      #     data_type: "LaserScan"
      #     raytrace_max_range: 3.0
      #     raytrace_min_range: 0.3
      #     obstacle_max_range: 2.5
      #     obstacle_min_range: 0.3
      
      # 障碍物层参数
      obstacle_layer_local:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: true
        observation_sources: scan
        combination_method: 1  # 取最大值组合方法
        footprint_clearing_enabled: true  # 启用footprint清理
        max_obstacle_height: 100.0
        min_obstacle_height: -100.0
        scan:
          topic: /scan
          max_obstacle_height: 100.0
          min_obstacle_height: -100.0
          clearing: true
          marking: true
          data_type: "LaserScan"
          raytrace_max_range: 5.0
          raytrace_min_range: 0.0
          obstacle_max_range: 5.0
          obstacle_min_range: 0.0
          # expected_update_rate: 0.0  # 新增参数
          # inf_is_valid: false  # 新增参数
          # observation_persistence: 0.0  # 新增参数
          # sensor_frame: ""  # 新增参数 - 空表示使用数据帧
      
      # 膨胀层参数 - 大幅增加膨胀半径和成本缩放，增强避障能力
      inflation_layer_local:
        plugin: "nav2_costmap_2d::InflationLayer"
        enabled: true
        inflation_radius: 0.5     # 大幅增加局部膨胀半径，避免贴边行走
        cost_scaling_factor: 2.0  # 大幅增加成本缩放因子，使靠近障碍物的路径代价急剧增加
        # inflate_unknown: false      # 新增参数
        # inflate_around_unknown: false  # 新增参数
      
      # 始终发送完整代价地图
      always_send_full_costmap: true

# =============================================================================
# Global Costmap Configuration
# =============================================================================
global_costmap:
  global_costmap:
    ros__parameters:
      # 缺失的顶层参数
      # bond_disable_heartbeat_timeout: false  # 新增参数
      use_sim_time: false
      update_frequency: 0.5
      publish_frequency: 0.5
      global_frame: map
      robot_base_frame: base_link
      transform_tolerance: 0.5
      
      # 地图参数
      footprint: "[[-0.4, -0.2], [-0.4, 0.2], [0.2, 0.2], [0.2, -0.2]]"  # 机器狗矩形footprint（base_link前移10cm）
      footprint_padding: 0.05  # footprint膨胀填充
      resolution: 0.05
      track_unknown_space: true
      
      # # 其他缺失参数
      # always_send_full_costmap: false  # 新增参数
      # footprint: ""  # 新增参数 - 使用robot_radius代替
      # footprint_padding: 0.01  # 新增参数
      # lethal_cost_threshold: 100  # 新增参数
      # map_topic: "/map"  # 新增参数
      # observation_sources: ""  # 新增参数
      # origin_x: 0.0  # 新增参数
      # origin_y: 0.0  # 新增参数
      # rolling_window: false  # 新增参数
      # trinary_costmap: true  # 新增参数
      # unknown_cost_value: 255  # 新增参数
      # use_maximum: false  # 新增参数
      # transform_tolerance: 0.3  # 新增参数
      
      # # 尺寸参数
      # width: 100  # 新增参数 - 地图宽度(米)
      # height: 100  # 新增参数 - 地图高度(米)
      
      # # 过滤器配置
      # filters: []  # 新增参数 - 无过滤器
    
      # 插件配置
      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]
      
      # 静态层参数
      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        enabled: true  # 新增参数
        map_topic: "/map"  # 新增参数
        # subscribe_to_updates: false  # 新增参数
        map_subscribe_transient_local: true
        # transform_tolerance: 0.3  # 新增参数
        footprint_clearing_enabled: true  # 新增参数
      
      # 障碍物层参数
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: true
        observation_sources: scan
        scan:
          topic: /scan
          max_obstacle_height: 1.8
          min_obstacle_height: -0.1
          clearing: true
          marking: true
          data_type: "LaserScan"
          raytrace_max_range: 10.0
          raytrace_min_range: 0.0
          obstacle_max_range: 10.0
          obstacle_min_range: 0.0
      
      # 膨胀层参数
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        enabled: true  # 新增参数
        inflation_radius: 1.0
        cost_scaling_factor: 1.0
        # inflate_unknown: false  # 新增参数
        # inflate_around_unknown: false  # 新增参数
      
      # 始终发送完整代价地图
      always_send_full_costmap: false

# =============================================================================
# Map Server Configuration
# =============================================================================
map_server:
  ros__parameters:
    use_sim_time: false
    yaml_filename: /home/ztl/slam_data/grid_map/mapfrom3d.yaml

# =============================================================================
# Smoother Server Configuration
# ==============================================================================
smoother_server:
  ros__parameters:
    # 缺失的顶层参数
    # bond_disable_heartbeat_timeout: false  # 新增参数
    use_sim_time: false
    # costmap_topic: "local_costmap/costmap_raw"  # 新增参数
    # footprint_topic: "local_costmap/published_footprint"  # 新增参数
    # robot_base_frame: "base_link"  # 新增参数
    transform_tolerance: 0.5  # 新增参数
    smoother_plugins: ["simple_smoother"]  # 新增参数
    
    # 路径平滑器参数 - 增强平滑效果
    simple_smoother:
      plugin: "nav2_smoother::SimpleSmoother"  # 新增参数
      do_refinement: false  # 新增参数
      max_its: 2 # 新增参数
      # tolerance: 1.0e-10  # 新增参数
      # w_data: 0.2  # 新增参数 - 数据权重
      # w_smooth: 1000.0  # 新增参数 - 平滑权重
      


# =============================================================================
# Behavior Server Configuration - 配合新行为树优化
# =============================================================================
behavior_server:
  ros__parameters:
    use_sim_time: false
    # log_level: "debug"  # 启用debug级别日志输出
    
    # 缺失参数 - 根据系统输出添加
    # bond_disable_heartbeat_timeout: false  # 新增参数
    behavior_plugins: ["spin", "backup", "drive_on_heading", "wait"]  # 修正参数名：plugins -> behavior_plugins
    # costmap_topic: "local_costmap/costmap_raw"  # 新增参数
    # footprint_topic: "local_costmap/published_footprint"  # 新增参数
    cycle_frequency: 20.0  # 新增参数
    # global_frame: "odom"  # 新增参数
    # robot_base_frame: "base_link"  # 新增参数
    # transform_tolerance: 0.1  # 新增参数
    # simulate_ahead_time: 2.0  # 新增参数
    # max_rotational_vel: 1.0  # 新增参数
    # min_rotational_vel: 0.1  # 新增参数
    # rotational_acc_lim: 1.0  # 新增参数
    
    # 旋转行为 - 用于方向调整
    spin:
      plugin: "nav2_behaviors/Spin"
      spin_dist: 1.57  # 旋转角度（弧度）
      max_rotational_vel: 1.0  # 移动到顶层参数
      min_rotational_vel: 0.5  # 移动到顶层参数
      rotational_acc_lim: 5.0  # 移动到顶层参数
      
    # 后退行为 - 用于脱离障碍物
    backup:
      plugin: "nav2_behaviors/BackUp"
      backup_dist: 0.5  # 增加后退距离，从0.15增加到0.25
      backup_speed: 0.15  # 增加后退速度，从0.025增加到0.1
      acceleration_limit: 1.5  # 新增参数
      deceleration_limit: -5.0  # 新增参数
      minimum_speed: 0.1  # 新增参数
      
    # 方向驱动行为 - 用于横向移动调整
    drive_on_heading:
      plugin: "nav2_behaviors/DriveOnHeading"
      min_dist: 0.2
      max_dist: 0.8  # 增加最大移动距离，从0.5增加到0.8
      max_speed: 0.5
      min_speed: 0.06
      min_theta_error: 0.1  # 减小最小角度误差，提高精度
      max_theta_error: 0.3  # 减小最大角度误差，提高精度
      speed_theta_error_scale: 0.3  # 调整角度误差缩放因子
      simulation_duration: 2.0  # 增加模拟持续时间，从1.0增加到2.0
      rotate_to_heading: true
      # max_rotational_vel: 1.0  # 移动到顶层参数
      # min_rotational_vel: 0.1  # 移动到顶层参数
      # rotational_acc_lim: 1.0  # 移动到顶层参数
      # acceleration_limit: 0.5  # 新增参数
      # deceleration_limit: -0.5  # 新增参数
      # minimum_speed: 0.01  # 新增参数
      
    # 等待行为 - 用于临时暂停
    wait:
      plugin: "nav2_behaviors/Wait"
      wait_duration: 2.0  # 等待持续时间（秒） 

# =============================================================================
# Waypoint Follower Configuration
# =============================================================================
waypoint_follower:
  ros__parameters:
    # 缺失的顶层参数
    # bond_disable_heartbeat_timeout: false  # 新增参数
    use_sim_time: false
    loop_rate: 40
    stop_on_failure: false
    waypoint_task_executor_plugin: "wait_at_waypoint"
    wait_at_waypoint:
      plugin: "nav2_waypoint_follower::WaitAtWaypoint"
      enabled: true
      waypoint_pause_duration: 200

































slam_toolbox_node:
  ros__parameters:
    # 基本设置
    use_sim_time: false

    # 模式 - "mapping" 或 "localization" 模式，用于 Ceres 问题创建的性能优化
    #     工作原理与使用场景
    # LifeLong Mapping模式详解
    # 这个模式非常适合需要长期在动态环境中工作的机器人。它通过多会话（multi-session） 的管理方式，允许机器人不断地将运行过程中感知到的新环境变化（如新增的障碍物、改变的布局）整合到现有地图中。同时，它也会利用诸如Chow-Liu树等算法对位姿图进行稀疏化，以控制计算和存储成本，确保系统能够长期稳定运行。简单来说，它让地图"活"起来，伴随机器人的一生共同演进。
    # Localization模式详解
    # 一旦你拥有了一张高质量的地图，并且环境相对稳定，就可以切换到Localization模式。在此模式下，slam_toolbox的核心任务不再是构建地图，而是像一个更强大的自适应蒙特卡洛定位（AMCL） 一样，专注于解决"我在哪里"的问题。它通过匹配当前的传感器观测和已知地图，来提供精确的位姿，并修正里程计累积的漂移。
    mode: "mapping"  

    # 调试 / 可视化
    # 发布频率与变换发布
    # 禁止 slam_toolbox 输出/更新 2D occupancy map（避免覆盖 nav2 的 /map）
    # 将 map_update_interval 设为 0 将停止发布 OccupancyGrid
    map_update_interval: 1.0
    publish_occupancy_map: true

    # 地图文件 - 启动时加载的位姿图文件名（可由 launch 时覆盖 map_file_name）
    # map_file_name: '/home/ztl/slam_data/posegraph/my_map'

    # 启动时用于定位（与 AMCL 的 /initialpose 等价的参数）
    # 格式: [x, y, yaw] (单位: 米, 弧度)
    # 值示例: 将初始位姿设为 x=33.5, y=3.5, yaw=1.57
    # map_start_pose: [1.5, 1.5, 0.57]

    # 如果想以 dock（第一节点）作为启动位置，可以启用下一项
    map_start_at_dock: false

    # 坐标系
    # 里程计坐标系
    odom_frame: odom
    # 地图坐标系
    map_frame: map
    # 基座坐标系
    base_frame: base_link

    # 激光与里程计话题
    # 扫描话题 - 绝对路径，即 /scan 而不是 scan
    scan_topic: /scan
    # 里程计话题
    odom_topic: /Odometry

    # 保持 transform publish（map->odom 发布通常需要）
    # 地图到里程计变换的发布周期，0 表示不发布变换
    transform_publish_period: 0.0

    # 传感器范围与匹配参数（可按需调优）
    # 最大激光范围 - 用于 2D 占用地图栅格化的最大激光范围
    max_laser_range: 60.0
    # 最小激光范围 - 用于 2D 占用地图栅格化的最小激光范围
    min_laser_range: 0.5

    # 使能局部scan-matching用于相对定位增强 - 必须启用以支持重定位
    use_scan_matching: false

    # 不启用内置的 map saver 服务以避免意外写盘或覆盖
    # 实例化地图保存服务并自订阅地图话题
    use_map_saver: false

    # =============================================================================
    # 新增重要参数配置 - 根据 ros2 param list 添加
    # =============================================================================
    
    # 角度方差惩罚 - 当匹配扫描与里程计位姿不同时应用的惩罚，用于重定位时惩罚与里程计不一致的位姿
    angle_variance_penalty: 1.0
    
    # 距离方差惩罚 - 当匹配扫描与里程计位姿不同时应用的惩罚，用于重定位时惩罚与里程计不一致的位姿
    distance_variance_penalty: 1.0
    
    # 最小角度惩罚 - 确保角度惩罚不会过大的最小惩罚值，防止重定位时角度变化过大
    minimum_angle_penalty: 0.3
    
    # 最小距离惩罚 - 确保距离惩罚不会过大的最小惩罚值，防止重定位时位置变化过大
    minimum_distance_penalty: 0.3
    
    # 是否启用闭环检测 - 必须启用才能支持重定位功能
    do_loop_closing: true
    
    # # 是否启用交互模式
    # enable_interactive_mode: false
    # interactive_mode: false
    
    # # 暂停新测量处理
    # paused_new_measurements: false
    
    # # 暂停处理
    # paused_processing: false
    
    # 位置协方差缩放 - 控制位置估计的不确定性，值越小表示对位置估计越自信
    position_covariance_scale: 0.3
    
    # 偏航角协方差缩放 - 控制角度估计的不确定性，值越小表示对角度估计越自信
    yaw_covariance_scale: 0.3
    
    # # 分辨率 - 地图分辨率
    resolution: 0.05
    
    # # 占用阈值 - 标记为占用的单元格的光束命中率与光束通过率的最小比率
    # occupancy_threshold: 0.65
    
    # # 地图名称
    # map_name: "map"
    
    # 最小时间间隔 - 扫描处理间隔，降低频率以减少计算负载，提高长距离稳定性
    minimum_time_interval: 0.2
    
    # 最小移动距离 - 触发地图更新的最小距离，增加距离阈值以减少频繁更新
    minimum_travel_distance: 0.2
    
    # 最小移动角度 - 触发地图更新的最小角度，增加角度阈值以减少频繁更新
    minimum_travel_heading: 0.08
    
    # 扫描缓冲区大小 - 增加缓冲区大小以支持更长的匹配距离，提高长距离稳定性
    scan_buffer_size: 200
    
    # 扫描队列大小 - 控制扫描数据的处理队列
    scan_queue_size: 10
    
    # 扫描缓冲区最大扫描距离 - 增加匹配距离范围，提高重定位能力
    scan_buffer_maximum_scan_distance: 20.0
    
    # # 最小通过距离 - 在单元格被标记为占用或未占用之前必须通过的光束数量
    # min_pass_through: 0.0
    
    # # 链接扫描最小响应（精细）
    # link_match_minimum_response_fine: 0.1
    
    # # 链接扫描最大距离
    # link_scan_maximum_distance: 10.0
    
    # 闭环匹配最大方差（粗略） - 控制闭环检测的匹配阈值，值越小匹配越严格
    loop_match_maximum_variance_coarse: 0.2
    
    # 闭环匹配最小链大小 - 检测闭环所需的最小连续匹配数
    loop_match_minimum_chain_size: 3
    
    # 闭环匹配最小响应（粗略） - 粗略匹配的最小响应阈值
    loop_match_minimum_response_coarse: 0.8
    
    # 闭环匹配最小响应（精细） - 精细匹配的最小响应阈值
    loop_match_minimum_response_fine: 0.1
    
    # 闭环搜索最大距离 - 增加搜索距离范围以支持更长的匹配，提高重定位能力
    loop_search_maximum_distance: 6.0
    
    # 闭环搜索空间维度 - 适当增加搜索空间尺寸以支持更长的匹配距离
    loop_search_space_dimension: 0.25
    
    # 闭环搜索空间分辨率 - 略微降低分辨率以减少计算负载，平衡性能
    loop_search_space_resolution: 0.008
    
    # 闭环搜索空间模糊偏差 - 用于平滑响应的多模态模糊量
    loop_search_space_smear_deviation: 0.025
    
    # 相关搜索空间维度 - 增加搜索空间尺寸以支持更长的匹配距离
    correlation_search_space_dimension: 0.4
    
    # 相关搜索空间分辨率 - 略微降低分辨率以减少计算负载，平衡性能
    correlation_search_space_resolution: 0.008
    
    # 相关搜索空间模糊偏差 - 相关匹配的模糊偏差
    correlation_search_space_smear_deviation: 0.025
    
    # 粗略角度分辨率 - 在扫描匹配中测试角度偏移范围的角度分辨率
    coarse_angle_resolution: 0.0174532925
    
    # 粗略搜索角度偏移 - 用于粗略扫描匹配的角度测试范围
    coarse_search_angle_offset: 0.0
    
    # 精细搜索角度偏移 - 用于精细扫描匹配的角度测试范围
    fine_search_angle_offset: 0.00174532925
    
    # 是否使用扫描重心 - 使用扫描重心进行匹配，提高重定位精度
    use_scan_barycenter: true
    
    # 是否使用响应扩展 - 如果未找到可行匹配，是否自动增加搜索网格大小，重定位时建议启用
    use_response_expansion: false
    
    # # 是否启用调试日志
    debug_logging: false
    
    # # 限制扫描频率
    throttle_scans: 1
    
    # # 变换超时
    transform_timeout: 0.5
    
    # # TF缓冲区持续时间
    tf_buffer_duration: 5.0
    
    # # 求解器插件 - 用于karto扫描求解器的非线性求解器类型
    # # 选项: solver_plugins::CeresSolver, solver_plugins::SpaSolver, solver_plugins::G2oSolver
    # # 默认: solver_plugins::CeresSolver
    # solver_plugin: "CeresSolver"
    
    # # Ceres求解器参数
    # # Ceres线性求解器 - Ceres使用的线性求解器
    # # 选项: SPARSE_NORMAL_CHOLESKY, SPARSE_SCHUR, ITERATIVE_SCHUR, CGNR
    # # 默认: SPARSE_NORMAL_CHOLESKY
    # ceres_linear_solver: "SPARSE_NORMAL_CHOLESKY"
    
    # # Ceres预处理器 - 与求解器一起使用的预处理器
    # # 选项: JACOBI, IDENTITY (无), SCHUR_JACOBI
    # # 默认: JACOBI
    # ceres_preconditioner: "JACOBI"
    
    # # Ceres信任区域策略 - 信任区域策略
    # # 选项: LEVENBERG_MARQUARDT, DOGLEG
    # # 默认: LEVENBERG_MARQUARDT
    # ceres_trust_strategy: "LEVENBERG_MARQUARDT"
    
    # # Ceres狗腿类型 - 如果信任策略是DOGLEG时使用的狗腿策略
    # # 选项: TRADITIONAL_DOGLEG, SUBSPACE_DOGLEG
    # # 默认: TRADITIONAL_DOGLEG
    # ceres_dogleg_type: "TRADITIONAL_DOGLEG"
    
    # # Ceres损失函数 - 用于拒绝异常值测量的损失函数类型
    # # 选项: None (等价于平方损失), HuberLoss, CauchyLoss
    # # 默认: None
    # ceres_loss_function: "Cauchy"

    # # QoS 参数配置 - 消息服务质量设置
    # qos_overrides:
    #   # 时钟话题订阅配置
    #   ./clock:
    #     subscription:
    #       depth: 10
    #       durability: "volatile"
    #       history: "keep_last"
    #       reliability: "reliable"
      
    #   # 参数事件发布配置
    #   ./parameter_events:
    #     publisher:
    #       depth: 10
    #       durability: "volatile"
    #       history: "keep_last"
    #       reliability: "reliable"
      
    #   # TF 发布配置
    #   ./tf:
    #     publisher:
    #       depth: 10
    #       durability: "volatile"
    #       history: "keep_last"
    #       reliability: "reliable"